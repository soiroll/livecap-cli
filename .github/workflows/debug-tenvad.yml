name: Debug TenVAD

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: [self-hosted, windows]

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Configure Persistent Paths
        shell: pwsh
        run: |
          $cacheRoot = "C:\LiveCap\Cache"
          New-Item -ItemType Directory -Force -Path "$cacheRoot\uv" | Out-Null
          New-Item -ItemType Directory -Force -Path "$cacheRoot\models" | Out-Null
          "UV_CACHE_DIR=$cacheRoot\uv" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "Configured persistent paths at $cacheRoot"

      - name: Use preinstalled Python
        shell: pwsh
        run: |
          $python = Get-Command python3.12 | Select-Object -ExpandProperty Source
          if (-not $python) { throw "python3.12 not found on runner" }
          Write-Host "Using python at $python"
          "PYTHON_EXE=$python" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append

      - name: Set up uv
        uses: astral-sh/setup-uv@v3

      - name: Restore UV_CACHE_DIR
        shell: pwsh
        run: |
          "UV_CACHE_DIR=C:\LiveCap\Cache\uv" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Setup Python environment
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force .venv -ErrorAction SilentlyContinue
          uv python pin "$Env:PYTHON_EXE"
          uv venv
          echo "$PWD/.venv/Scripts" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          Write-Host "Installing dependencies..."
          # Install vad-all extra (includes all VAD backends: silero, webrtc, tenvad, javad)
          uv pip install -e ".[vad-all]"
          uv pip install numpy scipy

          Write-Host "Setup complete"

      - name: System Info
        shell: pwsh
        run: |
          Write-Host "=== System Info ==="
          Write-Host "OS: $([System.Environment]::OSVersion.VersionString)"
          Write-Host "Python: $(python --version)"
          Write-Host "NumPy: $(python -c 'import numpy; print(numpy.__version__)')"

          Write-Host "`n=== ten_vad package info ==="
          python -c @"
          try:
              import ten_vad
              print(f'ten_vad location: {ten_vad.__file__}')
              print(f'ten_vad attributes: {dir(ten_vad)}')
          except ImportError as e:
              print(f'ten_vad not installed: {e}')
          "@

      - name: Run TenVAD Debug Script
        shell: pwsh
        run: |
          Write-Host "Running TenVAD debug script..."
          python scripts/debug_tenvad.py

      - name: Additional ten_vad investigation
        if: always()
        shell: pwsh
        run: |
          Write-Host "=== Additional ten_vad investigation ==="
          python -c @"
          import sys
          import traceback
          import numpy as np
          import warnings

          try:
              from ten_vad import TenVad

              # Investigate TenVad internals
              print('TenVad class attributes:')
              for attr in dir(TenVad):
                  if not attr.startswith('_'):
                      print(f'  {attr}')

              print('\nTenVad source location:')
              import inspect
              try:
                  print(inspect.getfile(TenVad))
              except:
                  print('  Could not determine source file')

              # Test with verbose error catching
              print('\n=== Creating TenVad instance ===')
              vad = TenVad(hop_size=256, threshold=0.5)
              print(f'Created: {vad}')

              # Check internal state
              print('\nInstance attributes:')
              for attr in dir(vad):
                  if not attr.startswith('__'):
                      try:
                          val = getattr(vad, attr)
                          if not callable(val):
                              print(f'  {attr} = {val}')
                      except:
                          pass

              # Create audio
              audio = (np.sin(np.linspace(0, 2*np.pi*440*0.1, 256)) * 16000).astype(np.int16)
              print(f'\nTest audio: shape={audio.shape}, range=[{audio.min()}, {audio.max()}]')

              # First process
              print('\n=== First process() ===')
              result = vad.process(audio)
              print(f'Result: {result}')

              # Create new instance
              print('\n=== Creating NEW TenVad instance ===')
              vad2 = TenVad(hop_size=256, threshold=0.5)
              print(f'Created: {vad2}')

              # Process with new instance
              print('\n=== Process with new instance ===')
              try:
                  result2 = vad2.process(audio)
                  print(f'Result: {result2}')
              except Exception as e:
                  print(f'ERROR: {e}')
                  traceback.print_exc()

                  # Try to get more info
                  print('\n=== Debugging the error ===')
                  print(f'vad2 after error:')
                  for attr in ['_handler', 'hop_size', 'threshold']:
                      if hasattr(vad2, attr):
                          print(f'  {attr} = {getattr(vad2, attr)}')

          except ImportError as e:
              print(f'ten_vad not installed: {e}')
          except OSError as e:
              print(f'ten_vad native library error: {e}')
          "@
